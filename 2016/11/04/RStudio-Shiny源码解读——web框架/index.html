<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>RStudio Shiny源码解读——web框架 | 王新远个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
    <meta name="author" content="wangxinyuan">
  
  
    <meta name="description" content="本文粗略的对https://github.com/rstudio/shiny/(2016-11-04) 源码讲解rstudio shiny的整体web框架的运转逻辑。分三部分：

shiny web框架如何使用
shiny web框架整体概要介绍
深入rstudio shiny源码分析

1.shiny web框架如何使用官方各种示例：http://shiny.rstudio.com/gall">
  
  <meta name="description" content="本文粗略的对https://github.com/rstudio/shiny/(2016-11-04) 源码讲解rstudio shiny的整体web框架的运转逻辑。分三部分：

shiny web框架如何使用
shiny web框架整体概要介绍
深入rstudio shiny源码分析

1.shiny web框架如何使用官方各种示例：http://shiny.rstudio.com/gall">
<meta property="og:type" content="article">
<meta property="og:title" content="RStudio Shiny源码解读——web框架">
<meta property="og:url" content="http://newfarking.com/2016/11/04/RStudio-Shiny源码解读——web框架/index.html">
<meta property="og:site_name" content="王新远个人博客">
<meta property="og:description" content="本文粗略的对https://github.com/rstudio/shiny/(2016-11-04) 源码讲解rstudio shiny的整体web框架的运转逻辑。分三部分：

shiny web框架如何使用
shiny web框架整体概要介绍
深入rstudio shiny源码分析

1.shiny web框架如何使用官方各种示例：http://shiny.rstudio.com/gall">
<meta property="og:image" content="http://newfarking.com/img/example_shiny.png">
<meta property="og:image" content="http://newfarking.com/img/shiny_web_framework.png">
<meta property="og:updated_time" content="2016-11-04T11:33:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RStudio Shiny源码解读——web框架">
<meta name="twitter:description" content="本文粗略的对https://github.com/rstudio/shiny/(2016-11-04) 源码讲解rstudio shiny的整体web框架的运转逻辑。分三部分：

shiny web框架如何使用
shiny web框架整体概要介绍
深入rstudio shiny源码分析

1.shiny web框架如何使用官方各种示例：http://shiny.rstudio.com/gall">
<meta name="twitter:image" content="http://newfarking.com/img/example_shiny.png">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>

<body>
  <div class="wrapper">
    <header id="header">
  <div class="title">
    <h1><a href="/">王新远个人博客</a></h1>
    <p><a href="/"></a></p>
  </div>
  <nav class="nav">
    <ul>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/reading">Reading</a></li>
      
        <li><a href="/about">About</a></li>
      
      
    </ul>
    <div class="clearfix"></div>
  </nav>
  <div class="clearfix"></div>
</header>
    <div class="content"><article class="post">
  <header>
    
      <div class="icon"></div>
      <a href="/2016/11/04/RStudio-Shiny源码解读——web框架/">
  <time datetime="2016-11-04T07:55:29.000Z">
    2016-11-04
  </time>
</a>
    
    
  
    <h1 class="title">RStudio Shiny源码解读——web框架</h1>
  

  </header>
  
  <div class="entry">
    
      <p>  本文粗略的对<a href="https://github.com/rstudio/shiny/" target="_blank" rel="external">https://github.com/rstudio/shiny/(2016-11-04) </a>源码讲解rstudio shiny的整体web框架的运转逻辑。分三部分：</p>
<ol>
<li>shiny web框架如何使用</li>
<li>shiny web框架整体概要介绍</li>
<li>深入rstudio shiny源码分析</li>
</ol>
<h1 id="1-shiny-web框架如何使用"><a href="#1-shiny-web框架如何使用" class="headerlink" title="1.shiny web框架如何使用"></a>1.shiny web框架如何使用</h1><p>官方各种示例：<a href="http://shiny.rstudio.com/gallery/" target="_blank" rel="external">http://shiny.rstudio.com/gallery/</a><br>简单示例:</p>
<h4 id="ui界面逻辑"><a href="#ui界面逻辑" class="headerlink" title="ui界面逻辑"></a>ui界面逻辑</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">shinyUI(fluidPage(</div><div class="line">    sliderInput(<span class="string">"bins"</span>, <span class="string">"Number of bins:"</span>, min = <span class="number">1</span>,</div><div class="line">        max = <span class="number">50</span>, value = <span class="number">30</span>),</div><div class="line">    mainPanel(plotOutput(<span class="string">"distPlot"</span>))</div><div class="line">))</div></pre></td></tr></table></figure>
<h4 id="server-逻辑"><a href="#server-逻辑" class="headerlink" title="server 逻辑"></a>server 逻辑</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shinyServer(<span class="keyword">function</span>(input, output) &#123;</div><div class="line">    output$distPlot &lt;- renderPlot(&#123;</div><div class="line">        x    &lt;- faithful[, <span class="number">2</span>]</div><div class="line">        bins &lt;- seq(min(x), max(x), length.out = input$bins + <span class="number">1</span>)</div><div class="line">        hist(x, breaks = bins, col = <span class="string">'darkgray'</span>, border = <span class="string">'white'</span>)</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h4 id="启动web服务"><a href="#启动web服务" class="headerlink" title="启动web服务"></a>启动web服务</h4><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">runApp(<span class="string">'~/dir'</span>)</div></pre></td></tr></table></figure>
<p>效果：<br><img src="/img/example_shiny.png" alt="exapmle"><br>shinyUI定义了两个页面组件：sliderInput（输入），plotOutput（图形输出）<br>shinyServer定义了，图形输出的逻辑，并且每当input$bins（sliderInput）有变化都会触发重新计算并输出到前端。<br>对开发者来说开发分析的工具非常简单，那么shiny内部是怎么实现的，runApp入口函数背后是什么逻辑？</p>
<h1 id="2-shiny-web框架整体概要介绍"><a href="#2-shiny-web框架整体概要介绍" class="headerlink" title="2.shiny web框架整体概要介绍"></a>2.shiny web框架整体概要介绍</h1><p><img src="/img/shiny_web_framework.png" alt="shiny web framework"><br>以上是总结的流程图。<br>概要以下几点：</p>
<ol>
<li>shiny通过createHttpuvApp函数来创建服务，监听端口，支持Http、websocket两种协议传输。</li>
<li>监听端口后，shiny通过main loop单线程来处理多用户发来的http、websocket请求。</li>
<li>每个用户发来请求，将于服务器建立websocket长连接，socket流来的请求基本为组件input修改的值和output$id需要重新计算并输出。shiny将output$id计算的任务保存到任务队列中去，供main loop执行。通过每个用户/websocket，shiny将会分配给一个shinysession来储存个人信息。</li>
<li>main loop主要执行两个事情：a. flushReact；b. flushAllSession。flushReact执行队列中的任务；flushAllSession为刷新每个shinySession缓存的output数据至前端。</li>
<li>如果端口收到http至直接返回相关的httpResponse<br>即，用户发来一个input修改output重绘的请求，shiny会将这个请求抽象成一个任务，等主线程来一个一个执行。排到队执行完了然后输出到前端。</li>
</ol>
<h1 id="3-深入rstudio-shiny源码分析"><a href="#3-深入rstudio-shiny源码分析" class="headerlink" title="3.深入rstudio shiny源码分析"></a>3.深入rstudio shiny源码分析</h1><p>分五部分讲：</p>
<ol>
<li>runApp创建web服务 &amp; mainloop每100ms读取用户请求</li>
<li>处理websocket请求</li>
<li>处理http请求</li>
<li>flushReact任务队列执行逻辑</li>
<li>flushAllSession任务执行结果刷新至用户端</li>
</ol>
<h2 id="3-1-runApp创建web服务-amp-mainloop每100ms读取用户请求"><a href="#3-1-runApp创建web服务-amp-mainloop每100ms读取用户请求" class="headerlink" title="3.1. runApp创建web服务&amp;mainloop每100ms读取用户请求"></a>3.1. runApp创建web服务&amp;mainloop每100ms读取用户请求</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># file: server.R</span></div><div class="line">runApp &lt;- <span class="keyword">function</span>(appDir, <span class="keyword">...</span>) &#123;</div><div class="line">    appParts &lt;- as.shiny.appobj(appDir) <span class="comment"># appDir 开发者代码，转变为一个shiny应用</span></div><div class="line">    server &lt;- startApp(appParts, port, host, quiet) <span class="comment"># 启动服务</span></div><div class="line">    <span class="keyword">while</span> (!.globals$stopped) &#123;</div><div class="line">        serviceApp() <span class="comment"># 刷新端口监听数据，读取用户请求</span></div><div class="line">        Sys.sleep(<span class="number">0.001</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">startApp &lt;- <span class="keyword">function</span>(appObj, port, host, quiet) &#123;</div><div class="line">    <span class="comment"># startServer in httpuv library</span></div><div class="line">    <span class="keyword">return</span>(startServer(host, port, handlerManager$createHttpuvApp()))     </div><div class="line">    <span class="comment"># createHttpuvApp定义了如何处理http、websocket请求的逻辑</span></div><div class="line">&#125;</div><div class="line"><span class="comment"># file: middleware.R</span></div><div class="line">HandlerManager &lt;- R6Class(<span class="string">"HandlerManager"</span>,</div><div class="line">    createHttpuvApp = <span class="keyword">function</span>() &#123;</div><div class="line">        list(</div><div class="line">            onHeaders = <span class="keyword">function</span>(req) &#123;&#125;,</div><div class="line">            call = .httpServer(<span class="keyword">function</span>(req)&#123;</div><div class="line">                handlers$invoke(req) </div><div class="line">                <span class="comment"># handlers 为shinyui.R中的uiHttpHandler，怎么关联的不细说</span></div><div class="line">            &#125;), <span class="comment"># http协议请求处理逻辑</span></div><div class="line">            onWSOpen = <span class="keyword">function</span>(ws) &#123;</div><div class="line">                <span class="keyword">return</span>(wsHandlers$invoke(ws))  </div><div class="line">                <span class="comment"># wsHandlers为createAppHandlers$createAppHandlers$ws，怎么关联的不细说</span></div><div class="line">            &#125; <span class="comment"># websocket协议请求处理逻辑</span></div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># file: server.R</span></div><div class="line">serviceApp &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">    flushReact() <span class="comment"># 刷新任务队列，执行队列中的任务</span></div><div class="line">    flushAllSessions() <span class="comment"># 刷新shinySession中任务执行出的缓存的结果至用户</span></div><div class="line">    maxTimeout &lt;- ifelse(interactive(), <span class="number">100</span>, <span class="number">1000</span>)</div><div class="line">    timeout &lt;- max(<span class="number">1</span>, min(maxTimeout, timerCallbacks$timeToNextEvent()))</div><div class="line">    service(timeout) <span class="comment"># 刷新端口监听数据，读取用户请求</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-2-处理websocket请求"><a href="#3-2-处理websocket请求" class="headerlink" title="3.2. 处理websocket请求"></a>3.2. 处理websocket请求</h2><p>一个组件值更改，将触发传递服务器websocket流中的数据：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"method"</span>:<span class="string">"update"</span>,</div><div class="line">    <span class="attr">"data"</span>:&#123;</div><div class="line">        <span class="attr">"machinedata-machine_date:shiny.date"</span>:<span class="string">"2016-11-03"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># file: server.R createAppHandlers$createAppHandlers$ws</span></div><div class="line">ws = <span class="keyword">function</span>(ws) &#123;</div><div class="line">    <span class="comment"># 每个websocket创建一个shinySession储存用户信息</span></div><div class="line">    shinysession &lt;- ShinySession$new(ws) </div><div class="line">    ws$onMessage(<span class="keyword">function</span>(binary, msg) &#123;</div><div class="line">        messageHandler(binary, msg) <span class="comment"># 消息接收，触发函数</span></div><div class="line">    &#125;</div><div class="line">    messageHandler &lt;- <span class="keyword">function</span>(binary, msg) &#123;</div><div class="line">        <span class="keyword">switch</span>( <span class="comment"># msg有两种：init、update</span></div><div class="line">            msg$method,</div><div class="line">            init = &#123; <span class="comment"># init 为页面加载后，组件初始化信息</span></div><div class="line">                <span class="comment"># serverFuncSource 为开发者写的shinyServer函数</span></div><div class="line">                serverFunc &lt;- withReactiveDomain(<span class="literal">NULL</span>, serverFuncSource()) </div><div class="line"><span class="comment"># argsForServerFunc：拿当前用户下的shinysession信息作为serverFunc的参数传入，</span></div><div class="line"><span class="comment"># 比如input,output,session信息</span></div><div class="line">                args &lt;- argsForServerFunc(serverFunc, shinysession)</div><div class="line">                do.call( </div><div class="line"><span class="comment"># 执行shinyServer函数，</span></div><div class="line"><span class="comment"># 此处将触发将output$xxx的计算任务包装为监控对象，等待放入任务队列</span></div><div class="line">                    wrapFunctionLabel(serverFunc, <span class="string">"server"</span>),</div><div class="line">                    args)</div><div class="line">            &#125;,</div><div class="line">            update = &#123; <span class="comment"># update 为组件展示请求数据</span></div><div class="line"><span class="comment"># 拿到input组件的值储存到shinysession$input中去供serverFunc调用</span></div><div class="line">                shinysession$manageInputs(msg$data) </div><div class="line">            &#125;,</div><div class="line">            shinysession$dispatch(msg) <span class="comment"># 忽略</span></div><div class="line">        )</div><div class="line"><span class="comment"># 拿到用户展示xxx的请求，将output$xxx包装好的observer对象放入队列</span></div><div class="line"><span class="comment"># 或者将其从队列中唤起resume()，并将需要yyy隐藏的在队列中挂起</span></div><div class="line">        shinysession$manageHiddenOutputs() </div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment"># 执行shinyServer函数，此处将触发将output$xxx的计算任务写入任务队列，</span></div><div class="line"><span class="comment"># 循环监听是否需要重新计算。如何发出的？！！！</span></div><div class="line"><span class="comment"># 以下逻辑有点难看懂</span></div><div class="line"><span class="comment"># 下面的设计将捕获表达式output$xxx &lt;- render(&#123;&#125;)每次调用，</span></div><div class="line"><span class="comment"># 并执行将render函数写入任务队列</span></div><div class="line"></div><div class="line"><span class="comment"># file: shiny.R</span></div><div class="line">`$&lt;-.shinyoutput` &lt;- <span class="keyword">function</span>(x, name, value) &#123; </div><div class="line"><span class="comment"># obj$xxx &lt;- xxx; obj为R对象，类型为shinyoutput时，触发本函数运行,像切面编程</span></div><div class="line">    name &lt;- .subset2(x, <span class="string">'ns'</span>)(name)</div><div class="line">    .subset2(x, <span class="string">'impl'</span>)$defineOutput(name, value, label)</div><div class="line">&#125;</div><div class="line"><span class="comment"># shinyoutput类型的定义</span></div><div class="line">.createOutputWriter &lt;- <span class="keyword">function</span>(shinysession, ns = identity) &#123;</div><div class="line">    structure(list(impl=shinysession, ns=ns), class=<span class="string">'shinyoutput'</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment"># 执行shinyServer函数传入的参数逻辑：argsForServerFunc</span></div><div class="line">argsForServerFunc &lt;- <span class="keyword">function</span>(serverFunc, session) &#123;</div><div class="line">    args &lt;- list(input = session$input, output = .createOutputWriter(session))</div><div class="line">    args$session &lt;- <span class="keyword">...</span></div><div class="line">&#125;</div><div class="line"><span class="comment"># 可见init调用shinyServer函数时，会将对开发者写的每个output$xxx执行defineOutput函数</span></div><div class="line"><span class="comment"># defineOuput为将output$xx抽象为一个任务插入队列中，定期监控（是否需要展示）执行</span></div><div class="line">defineOutput = <span class="keyword">function</span>(name, func, label) &#123;</div><div class="line">    <span class="comment"># 将output$xxx包装为一个函数</span></div><div class="line">    func &lt;- wrapFunctionLabel(func, paste0(<span class="string">"output$"</span>, name))</div><div class="line">    obs &lt;- observe(&#123;</div><div class="line">        value &lt;-shinyCallingHandlers(func()) <span class="comment"># 执行output$xx</span></div><div class="line">        <span class="comment"># 将render结果缓存起来，等待输出</span></div><div class="line">        private$invalidatedOutputValues$set(name, value) </div><div class="line">    &#125;) <span class="comment"># 包装为一个监控对象</span></div><div class="line">    private$.outputs[[name]] &lt;- obs</div><div class="line">&#125;</div><div class="line">obs$resume() <span class="comment"># 任务唤醒</span></div><div class="line">Observer &lt;- R6Class(</div><div class="line">    resume = <span class="keyword">function</span>() &#123;</div><div class="line">        .onResume()</div><div class="line">    &#125;</div><div class="line">    initialize = <span class="keyword">function</span>(func) &#123;</div><div class="line">        .createContext()$invalidate()</div><div class="line">    &#125;</div><div class="line">    .createContext = <span class="keyword">function</span>() &#123;</div><div class="line">        ctx &lt;- Context$new(.domain, .label, type=<span class="string">'observer'</span>, prevId=.prevId)</div><div class="line">        continue &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">            ctx$addPendingFlush(.priority) <span class="comment"># 加入队列=resume</span></div><div class="line">        &#125;</div><div class="line">        .onResume &lt;&lt;- continue</div><div class="line">        ctx$onFlush(<span class="keyword">function</span>() &#123;</div><div class="line">            shinyCallingHandlers(run()) <span class="comment"># run func=observer$new传入的函数</span></div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    run = <span class="keyword">function</span>() &#123;</div><div class="line">        ctx &lt;- .createContext() </div><div class="line"><span class="comment"># 确保执行完一次后，下次用户请求resume时，再插入队列执行</span></div><div class="line">        .execCount &lt;&lt;- .execCount + <span class="number">1L</span></div><div class="line">        ctx$run(.func)</div><div class="line">    &#125;,</div><div class="line">    )</div></pre></td></tr></table></figure>
<p>综上，ws中对请求的处理逻辑，init的话将output$xx全部转为可监控对象observer，update：id时将将output$id插入任务队列或者从队列中唤醒。等待主线程执行。</p>
<h2 id="3-3-处理http请求"><a href="#3-3-处理http请求" class="headerlink" title="3.3. 处理http请求"></a>3.3. 处理http请求</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># file: shinyui.R</span></div><div class="line">uiHttpHandler &lt;- <span class="keyword">function</span>(ui, uiPattern = <span class="string">"^/$"</span>) &#123;</div><div class="line">    renderPage(uiValue, textConn, showcaseMode)</div><div class="line">    html &lt;- paste(readLines(textConn, encoding = <span class="string">'UTF-8'</span>), collapse=<span class="string">'\n'</span>)</div><div class="line">    <span class="keyword">return</span>(httpResponse(<span class="number">200</span>, content=enc2utf8(html)))</div><div class="line">&#125;</div><div class="line"><span class="comment"># 此处可对html内容生成做个缓存，避免每次计算处理，耗时</span></div></pre></td></tr></table></figure>
<h2 id="3-4-flushReact任务队列执行逻辑"><a href="#3-4-flushReact任务队列执行逻辑" class="headerlink" title="3.4. flushReact任务队列执行逻辑"></a>3.4. flushReact任务队列执行逻辑</h2><p>主要逻辑为从队列中拿出未挂起的任务执行,分两个层面讲，数据结构（队列），程序流程<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># file: react.R</span></div><div class="line">flushReact &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">    .getReactiveEnvironment()$flush()</div><div class="line">&#125;</div><div class="line">.getReactiveEnvironment &lt;- local(&#123;</div><div class="line">    reactiveEnvironment &lt;&lt;- ReactiveEnvironment$new()</div><div class="line">&#125;)</div><div class="line">ReactiveEnvironment &lt;- R6Class( </div><div class="line">    .pendingFlush &lt;&lt;- PriorityQueue$new()</div><div class="line">    addPendingFlush = <span class="keyword">function</span>(ctx, priority) &#123;</div><div class="line">        .pendingFlush$enqueue(ctx, priority)</div><div class="line">    &#125;,</div><div class="line">    flush = <span class="keyword">function</span>() &#123;</div><div class="line">        <span class="keyword">while</span> (hasPendingFlush()) &#123;</div><div class="line">            ctx &lt;- .pendingFlush$dequeue()</div><div class="line">            ctx$executeFlushCallbacks()</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">)</div><div class="line"><span class="comment"># ctx 数据结构</span></div><div class="line">Context &lt;- R6Class(</div><div class="line">    addPendingFlush = <span class="keyword">function</span>(priority) &#123;</div><div class="line">        .getReactiveEnvironment()$addPendingFlush(self, priority)</div><div class="line">    &#125;</div><div class="line">    onFlush = <span class="keyword">function</span>(func) &#123; <span class="comment"># 用来储存将要执行的任务函数</span></div><div class="line">        .flushCallbacks &lt;&lt;- c(.flushCallbacks, func)</div><div class="line">    &#125;,</div><div class="line">    executeFlushCallbacks = <span class="keyword">function</span>() &#123;</div><div class="line">        lapply(.flushCallbacks, <span class="keyword">function</span>(flushCallback) &#123;</div><div class="line">            flushCallback()</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>涉及三个类型ReactiveEnvironment，Context，Observer，这里为啥设计这么复杂，还不明白。<br>简单的话，init时一次创建所有的observer对象，保留起来。用户请求时resume，resume触发插入队列。</p>
<h2 id="3-5-flushAllSession任务执行结果刷新至用户端"><a href="#3-5-flushAllSession任务执行结果刷新至用户端" class="headerlink" title="3.5. flushAllSession任务执行结果刷新至用户端"></a>3.5. flushAllSession任务执行结果刷新至用户端</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># observer任务中</span></div><div class="line">private$invalidatedOutputValues$set(name, value)</div><div class="line"><span class="comment"># invalidatedOutputValues将在flushAllSession中输出</span></div><div class="line">flushAllSessions &lt;- <span class="keyword">function</span>() &#123;</div><div class="line"><span class="comment"># 处理所有的session</span></div><div class="line">    lapply(appsByToken$values(), <span class="keyword">function</span>(shinysession) &#123;</div><div class="line">        shinysession$flushOutput()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">ShinySession &lt;- R6Class(</div><div class="line">    flushOutput = <span class="keyword">function</span>() &#123;</div><div class="line">        private$sendMessage(</div><div class="line">            values =as.list(private$invalidatedOutputValues)</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">)</div></pre></td></tr></table></figure>

    
  </div>
  <footer>
    
      
      
    
    <div class="clearfix"></div>
  </footer>
</article>


<section id="comment">
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2016/11/04/RStudio-Shiny源码解读——web框架/" data-title="RStudio Shiny源码解读——web框架" data-url="http://newfarking.github.io/http://newfarking.com/2016/11/04/RStudio-Shiny源码解读——web框架/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"newfarking"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</section>

</div>
  </div>
  <footer id="footer"><div class="copyright">
  
  &copy; 2016 <a href="/">wangxinyuan</a>
  
</div>
<div class="theme-copyright">
  Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a>
   | 
  Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a>
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="/js/scale.fix.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
  var duoshuoQuery = { short_name: 'newfarking' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
  (function($){
    $('.fancybox').fancybox();
  })(jQuery);
</script>

</body>
</html>